//使用自执行函数
;
(function (window) {
    function IndexFunction() {
        this.init();
    }
    IndexFunction.prototype = {
        constructor: IndexFunction,
        //页面初始化
        init: function () {
            // 加载图标
            this.getMenu();
            // 获取折扣信息
            this.getDiscount();
            // 加载更多图标
            this.loadMore();

            // this.goTop();
            this.showTime();
        },
        //获取导航按钮
        getMenu: function () {
            var that = this;
            $(function () {
                $.ajax({
                    //请求数据
                    url: 'http://139.199.192.48:9090/api/getindexmenu',
                    success: function (data) {
                        var arr = that.handleData(data);
                        var resultArr = [];
                        for (var i = 0; i < 8; i++) {
                            resultArr.push(arr[i])
                        }
                        resultArr.push({
                            src: 'http://m.manmanbuy.com/images/ic_temai.png',
                            name: '优惠券',
                            'titlehref': 'quanindex.html'
                        });
                        for (var j = 8; j < arr.length; j++) {
                            resultArr.push(arr[j]);
                        }
                        var obj = {
                            result: resultArr
                        }
                        //执行页面加载
                        that.render(obj);
                    }
                });
            });
        },
        // 对请求返回的信息进行二次处理
        handleData: function (data) {
            var result = data.result;
            var dataArray = [];
            for (var i = 0; i < result.length; i++) {
                var obj = {};
                var arr = result[i].img.split(' ');
                obj.src = 'http://m.manmanbuy.com/' + result[i].img.split(' ')[1].substring(5, arr[1].length - 1);
                obj.name = result[i].name;
                obj.titlehref = result[i].titlehref;
                dataArray.push(obj)
            }
            return dataArray;
        },
        // 按钮图标处理的方法
        loadMore: function () {
            // 定义第三方变量
            var flag = false;
            $(function () {
                $('.menu_bar .bar').on('tap', 'li:nth-child(8)', function () {
                    if (flag) {
                        //flag为true时从第九个按钮开始隐藏,执行完以后flag变为false
                        $('.menu_bar .bar li:nth-child(n+9)').hide();
                        flag = false;
                    } else {
                        // fla为false时从第九个按钮开始显示,执行完以后flag变为true
                        $('.menu_bar .bar li:nth-child(n+9)').show();
                        flag = true;
                    }
                });
            });
        },
        render: function (obj) {
            $('.menu_bar .bar').html(template('template', obj));
        },
        // 加载折扣信息的显示
        getDiscount: function () {
            $(function () {
                $.ajax({
                    // 获取数据信息
                    url: 'http://139.199.192.48:9090/api/getmoneyctrl',
                    success: function (data) {
                        $('.discountList').html(template('template1', data));

                    }
                });
            });
        },
        //返回页面顶部
        goTop: function () {
            $(function () {
                $('.go_top').tap(function () {
                    // 返回页面顶部
                    window.scrollTo(0, 0);
                    // $(window).scrollTo(0,0);
                    console.log(123);
                });
            });
        },
        //进度条加载加载进度
        showTime: function () {
            $(function () {
                document.onreadystatechange = function () {
                    //判断请求的信息是否返回完毕
                    if (document.readyState == "complete") {
                        var img = $('img');
                        var num = 0;
                        img.each(function (i) {
                            var oImg = new Image();
                            oImg.onload = function () {
                                oImg.onload = null;
                                num++;
                                $('.loading b').html(parseInt(num / $('img').size() * 100) + "%");
                                if (num >= i) {
                                    var timeId = setInterval(function () {
                                        $('.loading').fadeOut();
                                        clearInterval(timeId);
                                    }, 1000);

                                }
                            }
                            oImg.src = img[i].src;
                        });
                    }
                };
            });
        }
    }
    window.IF = window.IndexFunction = IndexFunction;
}(window));